{% if task_id %}

    <!-- html-component for showing progress bar -->
    <div>
        <!-- progress -->
        <div class='progress-wrapper'>
            <div id='progress-bar' class='progress-bar'
                 style="background-color: #68a9ef; width: 0%;">&nbsp;
            </div>
        </div>
        <!-- message -->
        <div id="progress-bar-message">
            Waiting for progress to start...
        </div>
    </div>

    <!-- js-component for updating progress bar -->
    <script type="text/javascript">
        let CeleryProgressBar = (function () {
            function onSuccessDefault(progressBarElement, progressBarMessageElement) {
                progressBarElement.style.backgroundColor = '#76ce60';
                progressBarMessageElement.innerHTML = "Success!";
            }

            function onErrorDefault(progressBarElement, progressBarMessageElement, progress) {
                progressBarElement.style.backgroundColor = '#dc4f63';
                progressBarMessageElement.innerHTML = "Something went wrong! ( " + progress.msg + ' ) ';
            }

            function onProgressDefault(progressBarElement, progressBarMessageElement, progress) {
                progressBarElement.style.backgroundColor = '#68a9ef';
                progressBarElement.style.width = progress.percent + "%";
                progressBarMessageElement.innerHTML = progress.current + ' / ' + progress.total + ' ( ' + progress.msg + ' ) ';
            }

            function updateProgress(progressUrl, options) {
                options = options || {};
                let progressBarId = options.progressBarId || 'progress-bar';
                let progressBarMessage = options.progressBarMessageId || 'progress-bar-message';
                let progressBarElement = options.progressBarElement || document.getElementById(progressBarId);
                let progressBarMessageElement = options.progressBarMessageElement || document.getElementById(progressBarMessage);
                let onProgress = options.onProgress || onProgressDefault;
                let onSuccess = options.onSuccess || onSuccessDefault;
                let onError = options.onError || onErrorDefault;
                let pollInterval = options.pollInterval || 500;

                fetch(progressUrl).then(function (response) {
                    response.json().then(function (data) {
                        if (data.progress) {
                            onProgress(progressBarElement, progressBarMessageElement, data.progress);
                        }
                        if (!data.complete) {
                            setTimeout(updateProgress, pollInterval, progressUrl, options);
                        } else {
                            if (data.success) {
                                onSuccess(progressBarElement, progressBarMessageElement);
                            } else {
                                onError(progressBarElement, progressBarMessageElement, data.progress);
                            }
                        }
                    });
                });
            }

            return {
                onSuccessDefault: onSuccessDefault,
                onErrorDefault: onErrorDefault,
                onProgressDefault: onProgressDefault,
                updateProgress: updateProgress,
                initProgressBar: updateProgress,  // just for api cleanliness
            };
        })();
    </script>

    <!-- init component -->
    <script type="text/javascript">
        $(function () {
            CeleryProgressBar.initProgressBar(
                "{% url 'celery_progress_bar:task_status' task_id %}"
            )
        });
    </script>

{% endif %}